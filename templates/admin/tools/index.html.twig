{% extends 'base_back.html.twig' %}

{% block title %}Tool Management{% endblock %}

{% block stylesheets %}
    <style>
        .tool-header {
            background-color: #f8f9fc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .tool-header h1 {
            margin-bottom: 0.5rem;
            font-weight: 700;
            color: #5a5a5a;
        }
        
        .tool-header p {
            color: #6c757d;
            margin-bottom: 0;
            font-size: 1rem;
            padding-top: 0.5rem;
            max-width: 80%;
        }
        
        .btn-add-tool {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: all 0.2s;
        }
        
        .btn-add-tool:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        
        .btn-add-tool i {
            margin-right: 0.5rem;
        }
        
        .table-responsive {
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            background-color: #f8f9fc;
            border-top: none;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #5a5a5a;
            letter-spacing: 0.05em;
            padding: 1rem;
            vertical-align: middle;
        }
        
        .table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
        }
        
        .table tr:hover {
            background-color: #f8f9fc;
        }
        
        .badge-description {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
            border-radius: 2rem;
            font-weight: 600;
        }
        
        .badge-critical {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .badge-non-critical {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .badge-manufacturer {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
            border-radius: 2rem;
            font-weight: 600;
            background-color: #e9ecef;
            color: #5a5a5a;
        }
        
        .btn-action {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            margin: 0 0.25rem;
            transition: all 0.2s;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
        }
        
        .btn-view {
            background-color: #e9ecef;
            color: #5a5a5a;
            border: none;
        }
        
        .btn-view:hover {
            background-color: #dee2e6;
            color: #343a40;
        }
        
        .btn-edit {
            background-color: #cff4fc;
            color: #055160;
            border: none;
        }
        
        .btn-edit:hover {
            background-color: #9eeaf9;
            color: #055160;
        }
        
        .btn-delete {
            background-color: #f8d7da;
            color: #842029;
            border: none;
        }
        
        .btn-delete:hover {
            background-color: #f5c2c7;
            color: #842029;
        }
        
        /* Styles pour les notifications AJAX */
        .ajax-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 9999;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .ajax-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .ajax-notification.success {
            background-color: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid #0f5132;
        }
        
        .ajax-notification.error {
            background-color: #f8d7da;
            color: #842029;
            border-left: 4px solid #842029;
        }
        
        .empty-state {
            padding: 3rem;
            text-align: center;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }
        
        .empty-state h5 {
            color: #6c757d;
            font-weight: 600;
        }
        
        .empty-state p {
            color: #adb5bd;
        }
        
        /* Confirmation modal styles */
        .swal2-popup {
            font-size: 0.9rem;
            border-radius: 0.75rem;
        }
        
        .swal2-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .swal2-content {
            font-size: 1rem;
        }
        
        .swal2-actions button {
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.5rem 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        /* DataTable Search Styles */
        .dataTables_wrapper .dataTables_filter {
            float: right;
            text-align: right;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .dataTables_wrapper .dataTables_filter label {
            font-weight: 600;
            color: #5a5a5a;
            display: flex;
            align-items: center;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            margin-left: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            font-size: 0.95rem;
            width: 250px;
            transition: all 0.2s ease;
            background-color: #f8f9fc;
        }
        
        .dataTables_wrapper .dataTables_filter input:focus {
            border-color: #adb5bd;
            box-shadow: 0 0 0 0.2rem rgba(173, 181, 189, 0.25);
            outline: 0;
            background-color: #fff;
        }
        
        .dataTables_wrapper .dataTables_filter::before {
            content: '\f002';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 225px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
            z-index: 1;
        }
        
        .dataTables_wrapper .dataTables_length {
            float: left;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .dataTables_wrapper .dataTables_length label {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #5a5a5a;
            margin-bottom: 0;
        }
        
        .dataTables_wrapper .dataTables_length select {
            margin: 0 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            background-color: #f8f9fc;
        }
        
        .dataTables_wrapper .dataTables_info {
            clear: both;
            float: left;
            padding-top: 1.25rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .dataTables_wrapper .dataTables_paginate {
            float: right;
            text-align: right;
            padding-top: 1.25rem;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.375rem 0.75rem;
            margin-left: 0.25rem;
            border-radius: 0.5rem;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #f8f9fc;
            border-color: #dee2e6;
            color: #5a5a5a !important;
            font-weight: 600;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        
        /* Add some spacing to the table */
        .card-body {
            padding: 1.5rem !important;
        }
        
        /* Add spacing between top controls and table */
        .top {
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* Button with spinner */
        .btn-with-spinner {
            position: relative;
        }
        
        .btn-with-spinner .spinner-border {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -0.5rem;
            margin-left: -0.5rem;
            display: none;
        }
        
        .btn-with-spinner.loading .spinner-border {
            display: block;
        }
        
        .btn-with-spinner.loading i {
            visibility: hidden;
        }
        
        /* Tool Details Modal Styles */
        .modal-tool-details .modal-content {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .modal-tool-details .modal-header {
            border-bottom: none;
            padding: 1.5rem 1.5rem 0.5rem;
            background-color: #f8f9fc;
        }
        
        .modal-tool-details .modal-body {
            padding: 1rem 1.5rem 1.5rem;
        }
        
        .modal-tool-details .modal-footer {
            border-top: none;
            padding: 1rem 1.5rem;
            background-color: #f8f9fc;
            justify-content: space-between;
        }
        
        .tool-details-card {
            border: none;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .tool-details-header {
            background-color: #f8f9fc;
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid #e3e6f0;
            position: relative;
        }
        
        .tool-details-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
        }
        
        .tool-details-content {
            padding: 1.5rem;
        }
        
        .tool-details-item {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .tool-details-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .tool-details-label {
            width: 40%;
            font-weight: 600;
            color: #5a5a5a;
        }
        
        .tool-details-value {
            width: 60%;
            color: #6c757d;
        }
        
        /* Tool Location Grid Styles */
        .tool-location-container {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #f8f9fc;
            border: 1px solid #e3e6f0;
        }
        
        .tool-location-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #5a5a5a;
            margin-bottom: 1.5rem;
        }
        
        .armoire-container {
            margin-bottom: 2rem;
        }
        
        .armoire-title {
            font-weight: 700;
            color: #5a5a5a;
            margin-bottom: 0.75rem;
            text-align: center;
        }
        
        .armoire-grid {
            display: flex;
            flex-direction: column;
        }
        
        .column-headers {
            display: flex;
            margin-left: 2rem;
        }
        
        .column-header {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #5a5a5a;
        }
        
        .grid-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .row-header {
            width: 2rem;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #5a5a5a;
        }
        
        .grid-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #adb5bd;
            margin-right: 0.5rem;
            position: relative;
            background-color: #ffffff;
        }
        
        .grid-cell:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-bottom: 15px solid #6c757d;
            border-right: 15px solid transparent;
        }
        
        .grid-cell.active {
            background-color: #e2f3e5;
            border-color: #28a745;
        }
        
        .grid-cell.active:after {
            border-bottom-color: #28a745;
        }
        
        .location-info {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .location-badge {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border-radius: 0.5rem;
            background-color: #e9ecef;
            color: #5a5a5a;
            font-weight: 600;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="tool-header d-sm-flex align-items-center justify-content-between">
            <div>
                <h1>Tool Management</h1>
                <p class="mt-2">View and manage all tools in the system</p>
                <br/>
            </div>
            <a href="{{ path('app_admin_tools_new') }}" class="btn btn-primary btn-add-tool">
                <i class="fas fa-plus"></i> Add New Tool
            </a>
        </div>

        <!-- Flash Messages -->
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }} alert-dismissible fade show mb-4" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endfor %}

        <!-- Tools List -->
        <div class="card shadow mb-4">
            <div class="card-body p-4">
                {% if toolsWithLastIO|length > 0 %}
                    <div class="table-responsive">
                        <table class="table" id="toolsTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th style="width: 12%">Availability</th>
                                    <th style="width: 12%">Inventory No.</th>
                                    <th style="width: 15%">Description</th>
                                    <th style="width: 15%">Manufacturer</th>
                                    <th style="width: 18%">Created At</th>
                                    <th style="width: 18%">Added By</th>
                                    <th style="width: 10%">Machine</th>
                                    <th style="width: 10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in toolsWithLastIO %}
                                    <tr>
                                        <td>
                                            {% if not item.lastIO or item.lastIO.status.value == 'IN' %}
                                                <span class="badge badge-non-critical">Available</span>
                                            {% else %}
                                                <span class="badge badge-critical">Unavailable</span>
                                            {% endif %}
                                        </td>
                                        <td><code>{{ item.tool.id }}</code></td>
                                        <td>
                                            <span class="badge badge-description {% if item.tool.description.value == 'Critical' %}badge-critical{% else %}badge-non-critical{% endif %}">
                                                {{ item.tool.description.value }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge badge-manufacturer">
                                                {{ item.tool.manufacturer.value }}
                                            </span>
                                        </td>
                                        <td>{{ item.tool.createdAt|date('Y-m-d H:i') }}</td>
                                        <td>{{ item.tool.createdBy.firstName }} {{ item.tool.createdBy.lastName }}</td>
                                        <td>
                                            {% if item.lastIO and item.lastIO.machine %}
                                                <span class="badge bg-light text-dark">{{ item.lastIO.machine }}</span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex">
                                                <button class="btn btn-action btn-view view-tool-btn" title="View details" data-id="{{ item.tool.id }}" data-armoire="{{ item.tool.armoire }}" data-dnas="{{ item.tool.dnas }}" data-emplacement="{{ item.tool.emplacement }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <a href="{{ path('app_admin_tools_edit', {'id': item.tool.id}) }}" class="btn btn-action btn-edit" title="Edit tool">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form id="delete-form-{{ item.tool.id }}" method="post" action="{{ path('app_admin_tools_delete', {'id': item.tool.id}) }}" class="d-inline">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ item.tool.id) }}">
                                                    <button type="button" class="btn btn-action btn-delete delete-tool-btn" title="Delete tool" data-id="{{ item.tool.id }}" data-token="{{ csrf_token('delete' ~ item.tool.id) }}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-tools"></i>
                        <h5>No Tools Found</h5>
                        <p>There are no tools in the system yet.</p>
                        <a href="{{ path('app_admin_tools_new') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Tool
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tool Details Modal -->
    <div class="modal fade modal-tool-details" id="toolDetailsModal" tabindex="-1" aria-labelledby="toolDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="toolDetailsModalLabel">Tool Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <div class="tool-details-header">
                        <h2 class="tool-details-name" id="toolDetailsId"></h2>
                            <div class="tool-details-actions">
                                <a href="#" class="btn btn-edit" id="toolEditBtn" title="Edit tool">
                                    <i class="fas fa-edit"></i>
                                </a>
                        </div>
                    </div>
                    
                    <div class="tool-details-content">
                        <div class="location-info">
                            <div class="location-badge" id="armoireBadge">Armoire: </div>
                            <div class="location-badge" id="dnasBadge">DNAS: </div>
                            <div class="location-badge" id="emplacementBadge">Emplacement: </div>
                        </div>
                        
                        <div class="tool-location-container">
                            <div class="tool-location-title">
                                <i class="fas fa-map-marker-alt me-2"></i> Tool Location Visualization
                            </div>
                            
                            <div id="armoire-grid-container">
                                <!-- The grid will be dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            // Initialize DataTable with same style as users page
            $('#toolsTable').DataTable({
                "order": [[4, "desc"]], // Order by created at column (descending) after adding Availability & Machine
                "pageLength": 5,
                "lengthMenu": [[5, 10, 25, 50, 100], [5, 10, 25, 50, 100]],
                "language": {
                    "search": "Search tools :",
                    "lengthMenu": "Show _MENU_ tools per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ tools",
                    "infoEmpty": "No tools available",
                    "infoFiltered": "(filtered from _MAX_ total tools)",
                    "zeroRecords": "No matching tools found"
                },
                "dom": '<"top"lf>rt<"bottom"ip>',
                "drawCallback": function() {
                    // Reattach events after each table redraw
                    attachDeleteEvents();
                    attachViewEvents();
                }
            });
            
            // Notification AJAX
            function showNotification(message, type) {
                const notification = $('<div>').addClass('ajax-notification ' + type).text(message);
                $('body').append(notification);
                
                setTimeout(() => {
                    notification.addClass('show');
                }, 100);
                
                setTimeout(() => {
                    notification.removeClass('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }
            
            // Function to generate the armoire grid
            function generateArmoireGrid(armoireNum, dnasLetter, emplacementNum) {
                const container = $('#armoire-grid-container');
                container.empty();
                
                // Create armoires
                for (let a = 1; a <= 5; a++) {
                    const armoireContainer = $('<div>').addClass('armoire-container');
                    const armoireTitle = $('<div>').addClass('armoire-title').text('Armoire ' + a);
                    armoireContainer.append(armoireTitle);
                    
                    const armoireGrid = $('<div>').addClass('armoire-grid');
                    
                    // Column headers (A, B, C, D)
                    const columnHeaders = $('<div>').addClass('column-headers');
                    ['A', 'B', 'C', 'D'].forEach(letter => {
                        columnHeaders.append($('<div>').addClass('column-header').text(letter));
                    });
                    armoireGrid.append(columnHeaders);
                    
                    // Grid rows
                    for (let row = 1; row <= 6; row++) {
                        const gridRow = $('<div>').addClass('grid-row');
                        const rowHeader = $('<div>').addClass('row-header').text(row);
                        gridRow.append(rowHeader);
                        
                        // Grid cells
                        ['A', 'B', 'C', 'D'].forEach(col => {
                            const cell = $('<div>').addClass('grid-cell');
                            
                            // Highlight the active cell
                            if (a.toString() === armoireNum && col === dnasLetter && row.toString() === emplacementNum) {
                                cell.addClass('active');
                            }
                            
                            gridRow.append(cell);
                        });
                        
                        armoireGrid.append(gridRow);
                    }
                    
                    armoireContainer.append(armoireGrid);
                    container.append(armoireContainer);
                }
            }
            
            // Function to attach delete events
            function attachDeleteEvents() {
                $(document).off('click', '.delete-tool-btn').on('click', '.delete-tool-btn', function() {
                    const toolId = $(this).data('id');
                    const token = $(this).data('token');
                    
                    Swal.fire({
                        title: 'Confirm Deletion',
                        html: `Are you sure you want to delete this tool?<br>This action cannot be undone.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'Yes, delete',
                        cancelButtonText: 'Cancel',
                        reverseButtons: true,
                        focusCancel: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Show loading state
                            Swal.fire({
                                title: 'Processing...',
                                text: 'Please wait while we process your request.',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            
                            // Submit the form
                            document.getElementById(`delete-form-${toolId}`).submit();
                        }
                    });
                });
            }
            
            // Function to attach view events
            function attachViewEvents() {
                $(document).off('click', '.view-tool-btn').on('click', '.view-tool-btn', function() {
                    const toolId = $(this).data('id');
                    const armoire = $(this).data('armoire');
                    const dnas = $(this).data('dnas');
                    const emplacement = $(this).data('emplacement');
                    
                    // Set up the modal with tool details
                    $('#toolDetailsId').text(toolId);
                    $('#armoireBadge').text('Armoire: ' + armoire);
                    $('#dnasBadge').text('DNAS: ' + dnas);
                    $('#emplacementBadge').text('Emplacement: ' + emplacement);
                    
                    // Generate the grid
                    generateArmoireGrid(armoire, dnas, emplacement);
                    
                    // Update action links
                    $('#toolEditBtn').attr('href', '/admin/tools/' + toolId + '/edit');
                    
                    // Show the modal
                    const toolDetailsModal = new bootstrap.Modal(document.getElementById('toolDetailsModal'));
                    toolDetailsModal.show();
                });
            }
            
            // Attach events on initial load
            attachDeleteEvents();
            attachViewEvents();
        });
    </script>
{% endblock %} 